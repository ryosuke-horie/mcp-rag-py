# mcp-rag-demo

## å®Ÿç¾ã—ãŸã„ã“ã¨

1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§RAGã‚’æ§‹ç¯‰ã—MCPã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
2. RAGã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®æƒ…å ±ã‚’æºœã‚è¾¼ã‚€ï¼ˆãƒãƒ¼ãƒ å›ºæœ‰ã®ãƒ«ãƒ¼ãƒ«ã‚„è¦ç´„ã€åˆ©ç”¨ã™ã‚‹æŠ€è¡“ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±ãªã©ï¼‰
3. Claudeç­‰ã®ãƒ„ãƒ¼ãƒ«ã‹ã‚‰MCPã‚’çµŒç”±ã—ã¦æƒ…å ±ã‚’å‘¼ã³å‡ºã—ã€ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã«æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã‚‹ã‹æ¤œè¨¼ã™ã‚‹

### Ollama ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™

RAG ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ã™ã‚‹åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ« (`bge-m3`) ã‚’ Ollama ã§åˆ©ç”¨å¯èƒ½ã«ã—ã¾ã™ã€‚

```bash
ollama run bge-m3
```
(åˆå›ã¯ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™)

### 5. (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®š

API ã‚µãƒ¼ãƒãƒ¼ã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã‚’ä¸Šæ›¸ãã§ãã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã‹ã€ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ä¸»ãªè¨­å®šé …ç›®ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯ `rag_api_server/config.py` å‚ç…§)ã€‚

*   `OLLAMA_BASE_URL`: Ollama ã‚µãƒ¼ãƒãƒ¼ã® URL (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `http://localhost:11434`)
*   `EMBEDDING_MODEL_NAME`: ä½¿ç”¨ã™ã‚‹åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«å (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `bge-m3`)
*   `DB_PATH`: DuckDB ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `vector_store.db`)
*   `TABLE_NAME`: ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«å (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `embeddings`)

## åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ (API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)

API ã‚µãƒ¼ãƒãƒ¼ã¯ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚Swagger UI (`http://127.0.0.1:8001/docs`) ã‹ã‚‰ã‚‚ç¢ºèªãƒ»è©¦ç”¨ã§ãã¾ã™ã€‚

*   **`GET /`**:
    *   **èª¬æ˜:** API ã‚µãƒ¼ãƒãƒ¼ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã€‚
    *   **ãƒ¬ã‚¹ãƒãƒ³ã‚¹:** `{"status": "healthy", "version": "ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³"}`
*   **`POST /documents/`**:
    *   **èª¬æ˜:** æŒ‡å®šã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (.txt, .md) ã‚’å‡¦ç†ã—ã€ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã€åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆã‚’è¡Œã„ã€ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã™ã€‚
    *   **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£:** `{"source_path": "å‡¦ç†å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹", "glob_pattern": "ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: **/*[.md|.txt])"}`
    *   **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (æˆåŠŸæ™‚):** `{"status": "success", "processed_documents": æ•°, "processed_chunks": æ•°, "message": "..."}`
    *   **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (å¤±æ•—æ™‚):** `{"detail": "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"}`
*   **`POST /search/`**:
    *   **èª¬æ˜:** æŒ‡å®šã•ã‚ŒãŸã‚¯ã‚¨ãƒªã«åŸºã¥ã„ã¦ã€ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰é¡ä¼¼åº¦ã®é«˜ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ£ãƒ³ã‚¯ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
    *   **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£:** `{"query": "æ¤œç´¢ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—", "top_k": å–å¾—ä»¶æ•° (ã‚ªãƒ—ã‚·ãƒ§ãƒ³, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 5)}`
    *   **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (æˆåŠŸæ™‚):** `{"results": [{"text": "ãƒãƒ£ãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ", "similarity": é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢}, ...]}`
    *   **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (å¤±æ•—æ™‚):** `{"detail": "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"}`

## ä½¿ã„æ–¹ (curl ä¾‹)

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```bash
curl http://127.0.0.1:8001/
```

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç™»éŒ²

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã® `docs` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç™»éŒ²ã™ã‚‹å ´åˆ:

```bash
curl -X POST -H "Content-Type: application/json" \
     -d '{"source_path": "docs"}' \
     http://127.0.0.1:8001/documents/
```

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ¤œç´¢

"DuckDB" ã¨ã„ã†ã‚¯ã‚¨ãƒªã§ä¸Šä½ 3 ä»¶ã‚’æ¤œç´¢ã™ã‚‹å ´åˆ:

```bash
curl -X POST -H "Content-Type: application/json" \
     -d '{"query": "DuckDB", "top_k": 3}' \
     http://127.0.0.1:8001/search/
```

## ğŸ—‚ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```text
mcp-rag/
â”œâ”€ pyproject.toml               # ãƒ«ãƒ¼ãƒˆ: uv ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å®šç¾©
â”œâ”€ src/
â”‚  â”œâ”€ rag_api_server/           # FastAPI ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚  â”‚  â”œâ”€ pyproject.toml         #   src-layout / editable
â”‚  â”‚  â””â”€ rag_api_server/â€¦       #   å®Ÿè£…
â”‚  â”œâ”€ rag_core/                 # RAG ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆEmbedding, VectorDBï¼‰
â”‚  â”‚  â”œâ”€ pyproject.toml
â”‚  â”‚  â””â”€ rag_core/â€¦
â”‚  â””â”€ mcp_adapter/              # (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) å¤–éƒ¨ MCP ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚¢ãƒ€ãƒ—ã‚¿
â”‚     â””â”€ â€¦
â””â”€ README.md                    # â† ã„ã¾è¦‹ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
```

* å„ã‚µãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ **â€œsrc/ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åâ€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**  
  ï¼ˆ`tool.setuptools.package-dir` ã¯çœç•¥ã—ã€`packages = ["rag_api_server"]` ãªã©ã§æŒ‡å®šï¼‰
* ãƒ«ãƒ¼ãƒˆ `pyproject.toml` ã¯ **ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç®¡ç†å°‚ç”¨**  
  ```toml
  [tool.uv]
  package = false                       # ãƒ«ãƒ¼ãƒˆè‡ªä½“ã¯ wheel åŒ–ã—ãªã„

  [tool.uv.workspace]
  members = [
    "src/rag_core",
    "src/rag_api_server",
    "src/mcp_adapter",
  ]
  # workspace = true ã§å„ãƒ¡ãƒ³ãƒãƒ¼ã‚’ editable install
  ```

---

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. å‰æ

| Tool | Version |
|------|---------|
| Python | **3.11 ä»¥ä¸Š (CPython)** |
| uv (pipx æ¨å¥¨) | `>=0.6.17` |
| DuckDB 1.2.x / Ollama 0.1.x | *rag_core ã‚’ä½¿ã†å ´åˆã®ã¿* |

```bash
pipx install "uv>=0.6.17,<0.7"
```

### 2. ä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ãƒ«ãƒ¼ãƒˆã§å®Ÿè¡Œ
uv sync
```

* `.venv/` ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã€  
  - `rag-core`, `rag-api-server`, `mcp-adapter` ãŒ **editable** ã§å…¥ã‚‹  
  - ä¾å­˜ï¼ˆLangChain, duckdb, torch ãªã©ï¼‰ãŒ **binary wheel** ã§å…¥ã‚‹
* ä¾å­˜ã‚’è¿½åŠ ã—ãŸã„å ´åˆã¯å„ã‚µãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `pyproject.toml` ã«è¿½è¨˜ã—  
  `uv sync` ã‚’å†å®Ÿè¡Œã™ã‚‹ã ã‘ã€‚

### 3. é–‹ç™ºã‚µãƒ¼ãƒã‚’èµ·å‹•

```bash
uv run uvicorn rag_api_server.main:app --reload
```

* `--reload` ä»˜ãã§ã‚‚ **å­ãƒ—ãƒ­ã‚»ã‚¹ãŒ editable ãƒ‘ã‚¹ã‚’è§£æ±º** ã§ãã‚‹æ§‹æˆã€‚  
  ï¼ˆmultiprocessing spawn å¯¾ç­–æ¸ˆã¿ï¼‰
* æ—¢å®šã§ <http://127.0.0.1:8000/docs> ã« Swagger UI ãŒç«‹ã¡ä¸ŠãŒã‚Šã¾ã™ã€‚

> **Tips**  
> - `uv run -p 9000 â€¦` ã§ãƒãƒ¼ãƒˆå¤‰æ›´  
> - `.env` ã« `RAG__EMBEDDING_MODEL=all-minilm` ãªã©ç’°å¢ƒå¤‰æ•°ã‚’ç½®ãã¨  
>   `rag_core` å´ã§ `pydantic-settings` ãŒè‡ªå‹•èª­ã¿è¾¼ã¿

---

## âš™ï¸ é–‹ç™ºæ™‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ¢

| ã‚¿ã‚¹ã‚¯ | ã‚³ãƒãƒ³ãƒ‰ |
|--------|---------|
| ä¾å­˜è¿½åŠ  | `uv pip install -e src/rag_core[dev]`<br>ï¼ˆã‚ã‚‹ã„ã¯ `pyproject.toml` ç·¨é›†å¾Œ `uv sync`ï¼‰ |
| Lint / Format | `uv run ruff check .` , `uv run ruff format .` |
| ãƒ†ã‚¹ãƒˆ | `uv run pytest` |
| ä»®æƒ³ç’°å¢ƒã‚’æ¨ã¦ã‚‹ | `rm -rf .venv uv.lock` |

---

## ğŸ“ ã‚ˆãã‚ã‚‹ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ

| ç—‡çŠ¶ | åŸå› ã¨å¯¾å‡¦ |
|------|-----------|
| `ModuleNotFoundError: rag_core` | ã‚µãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå´ `package-dir` ã®æŒ‡å®šãƒŸã‚¹<br>â†’ `packages = ["rag_core"]` ã ã‘ã«ã™ã‚‹ |
| `ModuleNotFoundError: langchain_ollama` ãªã© | LangChain 0.3 ç³»ã‹ã‚‰ **ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ†é›¢**<br>â†’ `langchain-ollama`, `langchain-openai` ãªã©ã‚’ `dependencies` ã¸è¿½åŠ  |
| ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã ã‘ ImportError | `uv run --package` ã‚’ä½¿ã‚ãš **ä¾å­˜ã¨ã—ã¦æ˜ç¤º** (ãƒ«ãƒ¼ãƒˆ `dependencies = ["rag_api_server"]`) |

---

> **Why uv?**  
> - `pip + venv` ã‚ˆã‚Š **20â€“30Ã— é«˜é€Ÿ** ãªè§£æ±ºï¼†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  
> - ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ **PEP 621 æº–æ‹ **ã®ã¾ã¾ editable ç®¡ç†  
> - `uv pip`, `uv run`, `uv venv` ã§ day-to-day ãŒå®Œçµ

ã“ã‚Œã§æ–°ã—ãã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸé–‹ç™ºè€…ã§ã‚‚  
```bash
git clone https://github.com/yourname/mcp-rag
cd mcp-rag
uv sync
uv run uvicorn rag_api_server.main:app --reload
```  
ã ã‘ã§ç’°å¢ƒæ§‹ç¯‰ï½ã‚µãƒ¼ãƒèµ·å‹•ãŒã§ãã¾ã™ã€‚